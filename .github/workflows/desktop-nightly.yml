name: Flutter Desktop Nightly

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/search_cms/**'
      - '.github/workflows/desktop-nightly.yml'
  schedule:
    # 06:00 UTC ≈ midnight / 11pm in SK depending on DST; adjust as you like
    - cron: '0 6 * * *'
  workflow_dispatch:

# Prevent overlapping runs fighting over the "nightly" tag/release
concurrency:
  group: flutter-desktop-nightly
  cancel-in-progress: false

permissions:
  contents: read

# All run steps default to the Flutter app folder in your monorepo
defaults:
  run:
    working-directory: frontend/search_cms

jobs:
  build:
    name: Build ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            build_cmd: flutter build windows --release
            out_dir: build/windows/x64/runner/Release
            artifact_name: search_cms-windows-x64
          - os: macos-latest
            platform: macos
            build_cmd: flutter build macos --release
            out_dir: build/macos/Build/Products/Release
            artifact_name: search_cms-macos
          - os: ubuntu-latest
            platform: linux
            build_cmd: flutter build linux --release
            out_dir: build/linux/x64/release/bundle
            artifact_name: search_cms-linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.35.x"    # Pin to a 3.35 compatible version
          cache: true

      - name: Cache pub (speeds up dependency installs)
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('frontend/search_cms/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Flutter Doctor (diagnostics)
        run: flutter doctor -v

      - name: Fetch Dependencies
        run: flutter pub get

      - name: Enable Desktop Targets (idempotent)
        run: |
          flutter config --enable-windows-desktop || true
          flutter config --enable-macos-desktop || true
          flutter config --enable-linux-desktop || true

      # Linux deps — often present, but this makes builds reliable
      - name: Install Linux build deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

      # (Optional) quick checks to catch obvious issues
      - name: Analyze & unit tests
        run: |
          flutter analyze
          flutter test --platform=vm

      - name: Build ${{ matrix.platform }}
        run: ${{ matrix.build_cmd }}

      # Package outputs into a single distributable per platform
      - name: Archive (Windows .zip)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\dist" | Out-Null
          Compress-Archive -Path "${{ matrix.out_dir }}\*" -DestinationPath "$env:GITHUB_WORKSPACE\dist\${{ matrix.artifact_name }}.zip" -Force

      - name: Archive (macOS .app -> .zip)
        if: matrix.os == 'macos-latest'
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/dist"
          APP_PATH=$(ls -d ${{ matrix.out_dir }}/*.app | head -n 1 || true)
          if [ -z "${APP_PATH:-}" ]; then
            echo "No .app found in ${{ matrix.out_dir }}"; ls -la ${{ matrix.out_dir }}; exit 1
          fi
          # ditto preserves extended attributes; better for .app bundling
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$GITHUB_WORKSPACE/dist/${{ matrix.artifact_name }}.zip"

      - name: Archive (Linux .tar.gz)
        if: matrix.os == 'ubuntu-latest'
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/dist"
          tar -C "${{ matrix.out_dir }}" -czf "$GITHUB_WORKSPACE/dist/${{ matrix.artifact_name }}.tar.gz" .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ github.workspace }}/dist/*

  publish-nightly:
    name: Publish Nightly Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      # Create or update the "nightly" prerelease and REPLACE assets each run
      - name: Create/Update Release (tag=nightly)
        uses: ncipollo/release-action@v1
        with:
          tag: nightly
          name: Nightly
          prerelease: true
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true
          artifacts: "dist/*"


